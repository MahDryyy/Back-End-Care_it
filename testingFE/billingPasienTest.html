<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Form BPJS RS</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .autocomplete-list {
            position: absolute;
            z-index: 9999;
            background: white;
            border: 1px solid #ced4da;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .autocomplete-list.show {
            display: block;
        }
        .autocomplete-item {
            padding: 8px;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background: #e9ecef;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        .select-loading {
            position: relative;
        }
        .select-loading::after {
            content: '';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }
        
        /* Searchable Dropdown Styles */
        .searchable-select-wrapper {
            position: relative;
        }
        .searchable-select-input {
            width: 100%;
            padding: 0.375rem 2.5rem 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            font-size: 1rem;
            line-height: 1.5;
            background-color: #fff;
            cursor: pointer;
        }
        .searchable-select-input:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .searchable-select-input.searching {
            cursor: text;
        }
        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
            max-height: 300px;
            overflow: hidden;
            display: none;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .searchable-select-dropdown.show {
            display: block;
        }
        .searchable-select-search {
            padding: 0.5rem;
            border-bottom: 1px solid #ced4da;
            background: #f8f9fa;
        }
        .searchable-select-search input {
            width: 100%;
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .searchable-select-options {
            max-height: 250px;
            overflow-y: auto;
        }
        .searchable-select-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .searchable-select-option:hover,
        .searchable-select-option.highlighted {
            background-color: #e9ecef;
        }
        .searchable-select-option.selected {
            background-color: #0d6efd;
            color: white;
        }
        .searchable-select-arrow {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            transition: transform 0.2s;
        }
        .searchable-select-wrapper.open .searchable-select-arrow {
            transform: translateY(-50%) rotate(180deg);
        }
        .searchable-select-no-results {
            padding: 0.75rem;
            text-align: center;
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        /* Multi-select Styles */
        .searchable-select-wrapper.multi-select .searchable-select-input {
            min-height: 38px;
            padding: 0.25rem 2.5rem 0.25rem 0.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.25rem;
        }
        .searchable-select-wrapper.multi-select .searchable-select-input:empty::before {
            content: attr(placeholder);
            color: #6c757d;
        }
        .selected-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background-color: #0d6efd;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            gap: 0.25rem;
        }
        .selected-chip .chip-remove {
            cursor: pointer;
            font-weight: bold;
            padding: 0 0.25rem;
            border-radius: 0.125rem;
            transition: background-color 0.2s;
        }
        .selected-chip .chip-remove:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .searchable-select-wrapper.multi-select .searchable-select-input input {
            flex: 1;
            min-width: 100px;
            border: none;
            outline: none;
            padding: 0.25rem;
            background: transparent;
            cursor: text;
        }
        .searchable-select-wrapper.multi-select .searchable-select-input input:focus {
            outline: none;
        }
        .searchable-select-option.selected {
            background-color: #0d6efd;
            color: white;
        }
        .searchable-select-option.selected::after {
            content: " ✓";
            float: right;
        }
    </style>
</head>

<body class="p-4 bg-light">

<div class="container">
    <h2 class="mb-4">Form Input BPJS</h2>

    <form id="bpjsForm" class="card p-4 shadow-sm">

        <!-- === DOKTER === -->
        <div class="mb-3">
            <label class="form-label">Nama Dokter</label>
            <div class="searchable-select-wrapper" id="wrapper_nama_dokter">
                <input type="text" class="searchable-select-input" id="nama_dokter" readonly placeholder="Dokter...">
                <span class="searchable-select-arrow">▼</span>
                <div class="searchable-select-dropdown" id="dropdown_nama_dokter">
                    <div class="searchable-select-search">
                        <input type="text" placeholder="Cari..." id="search_nama_dokter" autocomplete="off">
                    </div>
                    <div class="searchable-select-options" id="options_nama_dokter"></div>
                </div>
            </div>
            <select class="form-select d-none" id="select_nama_dokter" name="nama_dokter"></select>
        </div>

        <!-- NAMA PASIEN -->
        <div class="mb-3 position-relative">
            <label class="form-label">Nama Pasien</label>
            <input type="text" class="form-control" id="nama_pasien" autocomplete="off">
            <div id="list_pasien" class="autocomplete-list"></div>
            <input type="hidden" id="id_pasien" name="id_pasien">
        </div>

        <!-- Auto Fill -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Jenis Kelamin</label>
                <input type="text" class="form-control" id="jenis_kelamin" disabled>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Usia</label>
                <input type="number" class="form-control" id="usia" disabled>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Ruangan</label>
                <input type="text" class="form-control" id="ruangan" disabled>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Kelas</label>
                <input type="text" class="form-control" id="kelas" disabled>
            </div>
        </div>

        <!-- TINDAKAN -->
        <div class="mb-3">
            <label class="form-label">Tindakan RS</label>
            <div class="searchable-select-wrapper multi-select" id="wrapper_tarif_rs">
                <div class="searchable-select-input" id="tarif_rs" placeholder="-- Pilih --">
                    <input type="text" id="input_tarif_rs" placeholder="Tindakan..." autocomplete="off">
                </div>
                <span class="searchable-select-arrow">▼</span>
                <div class="searchable-select-dropdown" id="dropdown_tarif_rs">
                    <div class="searchable-select-search">
                        <input type="text" placeholder="Cari..." id="search_tarif_rs" autocomplete="off">
                    </div>
                    <div class="searchable-select-options" id="options_tarif_rs"></div>
                </div>
            </div>
            <select class="form-select d-none" id="select_tarif_rs" name="tarif_rs" multiple></select>
        </div>

        <!-- ICD -->
        <div class="mb-3">
            <label class="form-label">ICD 9</label>
            <div class="searchable-select-wrapper multi-select" id="wrapper_icd9">
                <div class="searchable-select-input" id="icd9" placeholder="-- Pilih --">
                    <input type="text" id="input_icd9" placeholder="-- Pilih --" autocomplete="off">
                </div>
                <span class="searchable-select-arrow">▼</span>
                <div class="searchable-select-dropdown" id="dropdown_icd9">
                    <div class="searchable-select-search">
                        <input type="text" placeholder="Cari..." id="search_icd9" autocomplete="off">
                    </div>
                    <div class="searchable-select-options" id="options_icd9"></div>
                </div>
            </div>
            <select class="form-select d-none" id="select_icd9" name="icd9" multiple></select>
        </div>

        <div class="mb-3">
            <label class="form-label">ICD 10</label>
            <div class="searchable-select-wrapper multi-select" id="wrapper_icd10">
                <div class="searchable-select-input" id="icd10" placeholder="-- Pilih --">
                    <input type="text" id="input_icd10" placeholder="-- Pilih --" autocomplete="off">
                </div>
                <span class="searchable-select-arrow">▼</span>
                <div class="searchable-select-dropdown" id="dropdown_icd10">
                    <div class="searchable-select-search">
                        <input type="text" placeholder="Cari..." id="search_icd10" autocomplete="off">
                    </div>
                    <div class="searchable-select-options" id="options_icd10"></div>
                </div>
            </div>
            <select class="form-select d-none" id="select_icd10" name="icd10" multiple></select>
        </div>

        <button class="btn btn-primary">Simpan</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

const API_BASE = "http://localhost:8081";
const FETCH_TIMEOUT = 10000;

// ============= UTILITY FUNCTIONS =============
function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT) {
    return Promise.race([
        fetch(url, options),
        new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Request timeout')), timeout)
        )
    ]);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ============= SEARCHABLE DROPDOWN FUNCTIONS =============
function initSearchableDropdown(selectId) {
    const wrapper = document.getElementById(`wrapper_${selectId}`);
    const input = document.getElementById(selectId);
    const inputField = document.getElementById(`input_${selectId}`) || input;
    const dropdown = document.getElementById(`dropdown_${selectId}`);
    const searchInput = document.getElementById(`search_${selectId}`);
    const optionsContainer = document.getElementById(`options_${selectId}`);
    const hiddenSelect = document.getElementById(`select_${selectId}`);
    
    if (!wrapper || !input || !dropdown || !searchInput || !optionsContainer) return;
    
    const isMultiSelect = wrapper.classList.contains('multi-select');
    let allOptions = [];
    let filteredOptions = [];
    let selectedIndex = -1;
    let selectedValues = new Set();
    
    // Toggle dropdown
    input.addEventListener('click', function(e) {
        // Don't open if clicking on chip remove button
        if (e.target.classList.contains('chip-remove')) return;
        e.stopPropagation();
        const isOpen = wrapper.classList.contains('open');
        closeAllDropdowns();
        if (!isOpen) {
            openDropdown();
        }
    });
    
    // For multi-select, also handle input field click and search
    if (isMultiSelect && inputField) {
        inputField.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = wrapper.classList.contains('open');
            closeAllDropdowns();
            if (!isOpen) {
                openDropdown();
            }
        });
        
        // Allow typing in input field for multi-select
        inputField.addEventListener('input', function() {
            const keyword = this.value.toLowerCase().trim();
            if (keyword) {
                const isOpen = wrapper.classList.contains('open');
                if (!isOpen) {
                    openDropdown();
                }
                searchInput.value = keyword;
                filterOptions(keyword);
            }
        });
    }
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        filterOptions(keyword);
    });
    
    // Prevent dropdown close when clicking inside
    dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
            closeDropdown();
        }
    });
    
    // Keyboard navigation
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            if (!wrapper.classList.contains('open')) {
                openDropdown();
            }
        }
    });
    
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            highlightNext();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            highlightPrev();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            selectHighlighted();
        } else if (e.key === 'Escape') {
            closeDropdown();
        }
    });
    
    function openDropdown() {
        wrapper.classList.add('open');
        dropdown.classList.add('show');
        if (!isMultiSelect) {
            input.classList.add('searching');
        }
        searchInput.value = '';
        searchInput.focus();
        filterOptions('');
    }
    
    function closeDropdown() {
        wrapper.classList.remove('open');
        dropdown.classList.remove('show');
        if (!isMultiSelect) {
            input.classList.remove('searching');
        }
        selectedIndex = -1;
    }
    
    function closeAllDropdowns() {
        document.querySelectorAll('.searchable-select-wrapper').forEach(w => {
            w.classList.remove('open');
            w.querySelector('.searchable-select-dropdown').classList.remove('show');
            w.querySelector('.searchable-select-input').classList.remove('searching');
        });
    }
    
    function filterOptions(keyword) {
        filteredOptions = keyword === '' 
            ? allOptions 
            : allOptions.filter(opt => opt.text.toLowerCase().includes(keyword));
        
        renderOptions();
    }
    
    function renderOptions() {
        optionsContainer.innerHTML = '';
        selectedIndex = -1;
        
        if (filteredOptions.length === 0) {
            optionsContainer.innerHTML = '<div class="searchable-select-no-results">Tidak ada hasil</div>';
            return;
        }
        
        filteredOptions.forEach((option, index) => {
            const div = document.createElement('div');
            div.className = 'searchable-select-option';
            div.textContent = option.text;
            div.dataset.value = option.value;
            div.dataset.index = index;
            
            // Check if selected (for multi-select)
            if (isMultiSelect && selectedValues.has(option.value)) {
                div.classList.add('selected');
            } else if (!isMultiSelect) {
                const currentInput = document.getElementById(`input_${selectId}`) || input;
                if (currentInput && currentInput.value === option.text) {
                    div.classList.add('selected');
                }
            }
            
            div.addEventListener('click', function() {
                selectOption(option.value, option.text);
            });
            
            div.addEventListener('mouseenter', function() {
                highlightOption(index);
            });
            
            optionsContainer.appendChild(div);
        });
    }
    
    function renderChips() {
        if (!isMultiSelect) return;
        
        // Clear input container
        input.innerHTML = '';
        
        // Add chips for selected items
        selectedValues.forEach(value => {
            const option = allOptions.find(opt => opt.value === value);
            if (option) {
                const chip = document.createElement('span');
                chip.className = 'selected-chip';
                chip.innerHTML = `
                    <span>${option.text}</span>
                    <span class="chip-remove" data-value="${value}">×</span>
                `;
                chip.querySelector('.chip-remove').addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeSelection(value);
                });
                input.appendChild(chip);
            }
        });
        
        // Add input field
        const inputEl = document.createElement('input');
        inputEl.type = 'text';
        inputEl.id = `input_${selectId}`;
        inputEl.placeholder = selectedValues.size === 0 ? input.getAttribute('placeholder') || '-- Pilih --' : '';
        inputEl.autocomplete = 'off';
        input.appendChild(inputEl);
        
        // Add event listeners to new input field
        inputEl.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = wrapper.classList.contains('open');
            closeAllDropdowns();
            if (!isOpen) {
                openDropdown();
            }
        });
        
        inputEl.addEventListener('input', function() {
            const keyword = this.value.toLowerCase().trim();
            if (keyword) {
                const isOpen = wrapper.classList.contains('open');
                if (!isOpen) {
                    openDropdown();
                }
                searchInput.value = keyword;
                filterOptions(keyword);
            }
        });
    }
    
    function highlightOption(index) {
        document.querySelectorAll(`#options_${selectId} .searchable-select-option`).forEach((opt, i) => {
            opt.classList.remove('highlighted');
            if (i === index) {
                opt.classList.add('highlighted');
                selectedIndex = index;
            }
        });
    }
    
    function highlightNext() {
        if (selectedIndex < filteredOptions.length - 1) {
            selectedIndex++;
            highlightOption(selectedIndex);
            scrollToHighlighted();
        }
    }
    
    function highlightPrev() {
        if (selectedIndex > 0) {
            selectedIndex--;
            highlightOption(selectedIndex);
            scrollToHighlighted();
        }
    }
    
    function scrollToHighlighted() {
        const highlighted = document.querySelector(`#options_${selectId} .searchable-select-option.highlighted`);
        if (highlighted) {
            highlighted.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    }
    
    function selectHighlighted() {
        if (selectedIndex >= 0 && selectedIndex < filteredOptions.length) {
            const option = filteredOptions[selectedIndex];
            selectOption(option.value, option.text);
        }
    }
    
    function selectOption(value, text) {
        if (isMultiSelect) {
            // Toggle selection for multi-select
            if (selectedValues.has(value)) {
                removeSelection(value);
            } else {
                selectedValues.add(value);
                if (hiddenSelect) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = text;
                    option.selected = true;
                    hiddenSelect.appendChild(option);
                }
                renderChips();
                renderOptions(); // Update checkmarks
            }
            // Keep dropdown open for multi-select
            searchInput.focus();
        } else {
            // Single select behavior
            inputField.value = text;
            input.classList.remove('searching');
            if (hiddenSelect) {
                hiddenSelect.value = value;
            }
            closeDropdown();
        }
        
        // Trigger change event
        const event = new Event('change', { bubbles: true });
        if (hiddenSelect) hiddenSelect.dispatchEvent(event);
    }
    
    function removeSelection(value) {
        selectedValues.delete(value);
        if (hiddenSelect) {
            const option = hiddenSelect.querySelector(`option[value="${value}"]`);
            if (option) option.remove();
        }
        renderChips();
        renderOptions(); // Update checkmarks
    }
    
    // Public function to set options
    return {
        setOptions: function(options) {
            allOptions = options;
            filteredOptions = options;
            if (isMultiSelect) {
                renderChips();
            }
            renderOptions();
        },
        getValue: function() {
            if (isMultiSelect) {
                return Array.from(selectedValues);
            }
            return hiddenSelect ? hiddenSelect.value : '';
        },
        setValue: function(value) {
            if (isMultiSelect) {
                // For multi-select, value should be an array
                if (Array.isArray(value)) {
                    selectedValues = new Set(value);
                    if (hiddenSelect) {
                        hiddenSelect.innerHTML = '';
                        value.forEach(val => {
                            const option = allOptions.find(opt => opt.value === val);
                            if (option) {
                                const optEl = document.createElement('option');
                                optEl.value = option.value;
                                optEl.textContent = option.text;
                                optEl.selected = true;
                                hiddenSelect.appendChild(optEl);
                            }
                        });
                    }
                    renderChips();
                    renderOptions();
                }
            } else {
                const option = allOptions.find(opt => opt.value === value);
                if (option) {
                    inputField.value = option.text;
                    if (hiddenSelect) hiddenSelect.value = value;
                }
            }
        }
    };
}

// Store dropdown instances
const dropdownInstances = {};

// ============= LOADER DROPDOWN =============
async function loadSelect(url, selectId, labelField) {
    const input = document.getElementById(selectId);
    const hiddenSelect = document.getElementById(`select_${selectId}`);
    if (!input && !hiddenSelect) return;
    
    // Initialize searchable dropdown if not already
    if (!dropdownInstances[selectId]) {
        dropdownInstances[selectId] = initSearchableDropdown(selectId);
    }
    
    // Show loading
    if (input) {
        input.value = 'Memuat...';
        input.disabled = true;
    }

    try {
        const res = await fetchWithTimeout(url);
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();

        // Debug: log struktur data untuk troubleshooting
        if (data.length > 0) {
            console.log(`[${selectId}] Data structure:`, Object.keys(data[0]));
            console.log(`[${selectId}] Looking for field: "${labelField}"`);
            console.log(`[${selectId}] First item:`, data[0]);
        }

        // Helper function untuk mendapatkan field value (case-insensitive dan flexible)
        function getFieldValue(item, fieldName) {
            // KHUSUS untuk tarif_rs: HANYA gunakan "Deskripsi", JANGAN pakai "KodeRS" (ID)
            if (selectId === 'tarif_rs') {
                // Coba langsung "Deskripsi"
                if (item['Deskripsi'] !== undefined && item['Deskripsi'] !== null && item['Deskripsi'] !== '') {
                    return item['Deskripsi'];
                }
                
                // Coba case-insensitive untuk "Deskripsi"
                const keys = Object.keys(item);
                const deskripsiKey = keys.find(k => k.toLowerCase() === 'deskripsi');
                if (deskripsiKey && item[deskripsiKey] !== null && item[deskripsiKey] !== '') {
                    return item[deskripsiKey];
                }
                
                // JANGAN fallback ke field lain untuk tarif_rs (terutama KodeRS)
                return null;
            }
            
            // Untuk dropdown lain, gunakan logic normal
            // Coba langsung
            if (item[fieldName] !== undefined && item[fieldName] !== null && item[fieldName] !== '') {
                return item[fieldName];
            }
            
            // Coba case-insensitive
            const lowerField = fieldName.toLowerCase();
            const keys = Object.keys(item);
            const foundKey = keys.find(k => k.toLowerCase() === lowerField);
            if (foundKey && item[foundKey] !== null && item[foundKey] !== '') {
                return item[foundKey];
            }
            
            // Coba partial match (jika fieldName adalah "Tindakan_RS", cari yang mengandung "tindakan")
            const partialMatch = keys.find(k => {
                const kLower = k.toLowerCase();
                const fieldLower = lowerField.replace(/_/g, '');
                return kLower.includes(fieldLower) || fieldLower.includes(kLower);
            });
            if (partialMatch && item[partialMatch] !== null && item[partialMatch] !== '') {
                console.log(`[${selectId}] Using partial match: "${partialMatch}" instead of "${fieldName}"`);
                return item[partialMatch];
            }
            
            // Jika tidak ditemukan, coba ambil field pertama yang ada value
            const firstValidKey = keys.find(k => item[k] !== null && item[k] !== '' && item[k] !== undefined);
            if (firstValidKey) {
                console.warn(`[${selectId}] Field "${fieldName}" not found, using "${firstValidKey}" instead`);
                return item[firstValidKey];
            }
            
            return null;
        }

        // Build options array untuk searchable dropdown
        const options = [];
        
        data.forEach(item => {
            const value = getFieldValue(item, labelField);
            
            // Skip jika value kosong/null
            if (!value || value.toString().trim() === '') {
                return;
            }
            
            const valueStr = value.toString().trim();
            options.push({
                value: valueStr,
                text: valueStr
            });
        });
        
        if (options.length === 0) {
            console.warn(`[${selectId}] No valid data found! Field "${labelField}" may not exist.`);
            if (input) {
                input.value = 'Data tidak tersedia';
                input.disabled = true;
            }
        } else {
            // Set options ke searchable dropdown
            if (dropdownInstances[selectId]) {
                dropdownInstances[selectId].setOptions(options);
            }
            
            // Set options ke hidden select juga
            if (hiddenSelect) {
                hiddenSelect.innerHTML = '<option value="">-- Pilih --</option>';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    hiddenSelect.appendChild(option);
                });
            }
            
            if (input) {
                input.value = '';
                input.disabled = false;
                input.placeholder = '-- Pilih --';
            }
            
            console.log(`[${selectId}] Loaded ${options.length} items`);
        }
    } catch (error) {
        console.error(`Error loading ${selectId}:`, error);
        if (input) {
            input.value = 'Error memuat data';
            input.disabled = true;
        }
    }
}

// ============= LOAD SEMUA DROPDOWN =============
async function loadAllSelects() {
    // Load semua dropdown secara paralel untuk performa lebih baik
    await Promise.all([
        loadSelect(`${API_BASE}/dokter`, 'nama_dokter', 'Nama_Dokter'),
        // Untuk tarif_rs: gunakan field "Deskripsi" dari JSON response (bukan KodeRS/ID)
        loadSelect(`${API_BASE}/tarifRS`, 'tarif_rs', 'Deskripsi'),
        loadSelect(`${API_BASE}/icd9`, 'icd9', 'Prosedur'),
        loadSelect(`${API_BASE}/icd10`, 'icd10', 'Diagnosa')
    ]);
}

// Initialize all searchable dropdowns
function initAllDropdowns() {
    const dropdownIds = ['nama_dokter', 'tarif_rs', 'icd9', 'icd10'];
    dropdownIds.forEach(id => {
        if (!dropdownInstances[id]) {
            dropdownInstances[id] = initSearchableDropdown(id);
        }
    });
}

// Load saat DOM ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initAllDropdowns();
        loadAllSelects();
    });
} else {
    initAllDropdowns();
    loadAllSelects();
}

// ============= AUTOCOMPLETE PASIEN =============
const inputPasien = document.getElementById('nama_pasien');
const listPasien = document.getElementById('list_pasien');
let searchTimeout;
let currentSearchAbortController = null;

async function searchPasien(keyword) {
    // Cancel previous request jika masih pending
    if (currentSearchAbortController) {
        currentSearchAbortController.abort();
    }
    
    if (keyword.length < 2) {
        listPasien.innerHTML = '';
        listPasien.classList.remove('show');
        return;
    }

    // Tampilkan loading
    listPasien.innerHTML = '<div class="autocomplete-item text-center"><span class="spinner-border spinner-border-sm me-2"></span>Mencari...</div>';
    listPasien.classList.add('show');

    try {
        // Buat AbortController untuk cancel request
        currentSearchAbortController = new AbortController();
        
        const res = await fetchWithTimeout(
            `${API_BASE}/pasien/search?nama=${encodeURIComponent(keyword)}`,
            { signal: currentSearchAbortController.signal }
        );
        
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();

        // Optimasi: gunakan DocumentFragment untuk batch DOM updates
        listPasien.innerHTML = '';
        if (data.length === 0) {
            listPasien.innerHTML = '<div class="autocomplete-item text-muted">Tidak ada hasil</div>';
        } else {
            const fragment = document.createDocumentFragment();
            data.forEach(p => {
                const div = document.createElement('div');
                div.classList.add('autocomplete-item');
                div.textContent = p.Nama_Pasien;
                div.onclick = () => fillPasien(p);
                fragment.appendChild(div);
            });
            listPasien.appendChild(fragment);
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            // Request dibatalkan, ignore
            return;
        }
        console.error('Error searching pasien:', error);
        listPasien.innerHTML = '<div class="autocomplete-item text-danger">Error: Gagal memuat data</div>';
    }
}

// Debounce autocomplete dengan delay 300ms
const debouncedSearchPasien = debounce(searchPasien, 300);

inputPasien.addEventListener('input', function () {
    debouncedSearchPasien(this.value.trim());
});

// Hide autocomplete saat klik di luar
document.addEventListener('click', function(e) {
    if (!inputPasien.contains(e.target) && !listPasien.contains(e.target)) {
        listPasien.classList.remove('show');
    }
});

function fillPasien(p) {
    inputPasien.value = p.Nama_Pasien;
    listPasien.innerHTML = '';
    listPasien.classList.remove('show');

    document.getElementById('id_pasien').value = p.ID_Pasien;
    document.getElementById('jenis_kelamin').value = p.Jenis_Kelamin || '';
    document.getElementById('usia').value = p.Usia || '';
    document.getElementById('ruangan').value = p.Ruangan || '';
    document.getElementById('kelas').value = p.Kelas || '';
}

</script>

</body>
</html>
